import posix~[Clib{headers=@{"unistd.h", "errno.h"}}] in c;

;; Struct representing a file handle.
struct File {
    fd: Int = -1;
}

struct Str {
    addr: Ptr~Byte;
    len: Usize;
}

func str~[StrCtor{prefix="", interpolation=false}] (
    addr: Ptr, size: Usize
) -> Str {
    return Str{addr, size};
}

struct ErrnoError {
    code: Int;
}

func to(err: ErrnoError, :Bool) -> Bool {
	return err.code!= 0;
}

;; Writes `msg` to `f`
func write(f: File, msg: Str) -> void | ErrnoError {
    total : mut Usize;
    while (total < msg.len) {
        written : Usize = c.write(
            f.fd, msg.addr + total, msg.len - total
        );
        if (written < 0) {
            error ErrnoError{c.errno};
        }
        total += written;
    }
}

func print(msg: Str) -> void {
    stdout := File{1};
    stdout'write(msg);
}

func main~EntryPoint() {
    print("Hello World\n");
}
